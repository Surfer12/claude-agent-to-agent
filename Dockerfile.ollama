FROM alpine:3.19 AS downloader

# Install curl and ca-certificates for downloading
RUN apk add --no-cache curl ca-certificates

# Download Ollama binary with checksum verification
WORKDIR /tmp
RUN curl -fsSL https://ollama.com/download/ollama-linux-amd64 -o ollama && \
    chmod +x ollama

FROM alpine:3.19

# Install runtime dependencies
RUN apk add --no-cache ca-certificates libc6-compat

# Create non-root user for security
RUN addgroup -g 1000 ollama && \
    adduser -D -s /bin/sh -u 1000 -G ollama ollama

# Create directories with proper permissions
RUN mkdir -p /ollama && \
    chown -R ollama:ollama /ollama

# Copy Ollama binary from downloader stage
COPY --from=downloader --chown=ollama:ollama /tmp/ollama /usr/local/bin/ollama

# Switch to non-root user
USER ollama

# Set environment variables
ENV OLLAMA_MODELS=/ollama
ENV OLLAMA_HOST=0.0.0.0:11434

# Expose port
EXPOSE 11434

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD curl -f http://localhost:11434/api/tags || exit 1

# Start Ollama server
CMD ["ollama", "serve"]